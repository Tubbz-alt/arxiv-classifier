steps:
  # Copy down the model
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |      
        gsutil cp gs://arxiv-classifier-dev-models/models.tar.xz models.tar.xz
        xz --decompress models.tar.xz
        tar xf models.tar
  # Do the docker build
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build',
    '--build-arg', 'git_commit=$SHORT_SHA',
    '-t', 'gcr.io/$PROJECT_ID/classifier',
    '--label', 'git-commit=$SHORT_SHA',
    '--label', 'github-repo=$REPO_NAME',
    '.' ]
  # Deploy to GCP
  - name: 'gcr.io/cloud-builders/gcloud:slim'
    args: [ 'gcloud',  'compute', 'instances', 'create-with-container',
    '$REPO_NAME:$SHORT_SHA' ,
    '--container-image',
    'gcr.io/$PROJECT_ID/classifier:latest']

images: ['gcr.io/$PROJECT_ID/classifier']
